---
import Layout from '../layouts/Layout.astro';
import type { Case } from '../types/index';
import DecryptedText from '../components/DecryptedText.jsx';

// Import JSON with proper typing
const casesData: Case[] = await import('../data/cases.json').then(m => m.default);
const title = "Dossier — 1985007";

// Transform case data for frontend consumption
const CASES = casesData.map(caseItem => ({
  id: caseItem.id,
  slug: caseItem.slug,
  title: `${caseItem.id} • ${caseItem.title.split(': ')[1] || caseItem.title}`,
  date: new Date(caseItem.date).getFullYear().toString(),
  summary: caseItem.summary,
  tags: caseItem.tags,
  year: caseItem.year
}));
---

<Layout title={title}>
  <main class="dossier-main loading" data-swup-transition>
    <a class="back-btn" href="/" aria-label="Back to Home">← BACK</a>

    <section class="dossier-access" aria-labelledby="dossier-heading">
      <div class="access-meta">
        <h1 id="dossier-heading" class="uppercase">Accessing case-file: <span class="mono">
          <DecryptedText client:load text="LIFE OF SHADE'S" initialDisplay="1985-007" />
</span>
</h1>
        <div class="access-panel" role="status" aria-live="polite" aria-atomic="true">
          <div class="access-header">
            <span class="access-badge">ACCESSING</span>
            <span class="access-title">CLASSIFIED FILES</span>
          </div>

          <div class="progress-wrap" aria-hidden="true">
            <div class="progress-track">
              <div class="progress-fill" id="decrypt-line"></div>
            </div>
          </div>

          <div class="loader-info small">Decrypting... <span id="decrypt-percent">0</span>%</div>
        </div>
      </div>
    </section>

    <div class="dossier-content" style="opacity: 0; pointer-events: none;">
      <section class="dossier-main-content">
        <h2 class="dossier-title">DOSSIER</h2>

        <nav class="timeline-nav" role="navigation" aria-label="Timeline filter">
          <h3 class="sr-only">TIMELINE NAV BAR</h3>
          <div class="pills" role="tablist" aria-label="Filter timeline by decade">
            <button class="pill" data-year="all" aria-pressed="true">All</button>
            <button class="pill" data-year="1985">1985</button>
            <button class="pill" data-year="1990s">1990s</button>
            <button class="pill" data-year="2001">2001</button>
            <button class="pill" data-year="2010s">2010s</button>
            <button class="pill" data-year="Present">Present</button>
          </div>
        </nav>

        <section class="timeline-entries" aria-label="Timeline entries">
          <h3 class="section-title">
            <DecryptedText client:load text="Case-Study Chapters" initialDisplay="TIMELINE ENTRIES" />
          </h3>
          <div class="grid cases-grid" id="cases-grid" aria-live="polite" aria-busy="true">
            <!-- Dynamic cards will be rendered here by client-side script. Skeletons are shown while data loads. -->
          </div>
        </section>
      </section>
    </div>
  </main>

  <!-- Inject server-side CASES into a safe window variable for client rendering -->
  <script set:html={`window.__CASES = ${JSON.stringify(CASES)};`}></script>

  <script>
    // @ts-nocheck
    (function(){
      // Elements
      const dossierMain = document.querySelector('.dossier-main');
      const dossierContent = document.querySelector('.dossier-content');
      const grid = document.getElementById('cases-grid');
      const percentEl = document.getElementById('decrypt-percent');
      const lineEl = document.getElementById('decrypt-line');
      const accessPanel = document.querySelector('.access-panel');

      if(!dossierMain || !grid || !accessPanel) return;

      // Utility: animate loader, returns a Promise — singleton so multiple calls reuse the same loader
      let __currentLoaderPromise = null;
      let __loaderStartTime = null;
  function animateLoader(duration = 6000){
        if(__currentLoaderPromise) {
          // if a loader is already running, extend its duration if requested longer
          // (no-op otherwise) and return the same promise so callers share it
          return __currentLoaderPromise;
        }

        __currentLoaderPromise = new Promise((resolve) => {
          if(!percentEl || !lineEl) { resolve(); __currentLoaderPromise = null; return; }
          let p = 0; percentEl.textContent = '0'; lineEl.style.width = '0%';
          const start = performance.now();
          __loaderStartTime = start;
          const dur = Math.max(500, duration);

          function step(ts){
            const t = Math.min(1, (ts - start) / dur);
            p = Math.floor(t * 100);
            percentEl.textContent = String(p);
            lineEl.style.width = p + '%';
            if(t < 1) requestAnimationFrame(step);
            else {
              percentEl.textContent = '100';
              lineEl.style.width = '100%';
              setTimeout(() => { __currentLoaderPromise = null; __loaderStartTime = null; resolve(); }, 200);
            }
          }

          requestAnimationFrame(step);
        });

        return __currentLoaderPromise;
      }

      function showDossierContent(){
        dossierMain.classList.remove('loading');
        if(accessPanel) {
          accessPanel.style.opacity = '0';
          accessPanel.style.pointerEvents = 'none';
          accessPanel.style.transition = 'opacity 0.35s ease';
          // hide after transition to remove from flow
          setTimeout(() => { accessPanel.style.display = 'none'; }, 400);
        }
        if(dossierContent){
          dossierContent.style.transition = 'opacity 0.45s ease';
          dossierContent.style.opacity = '1';
          dossierContent.style.pointerEvents = 'auto';
        }
      }

      function showSkeletons(count){
        grid.innerHTML = '';
        const wrapper = document.createElement('div'); wrapper.className = 'skeleton-grid';
        for(let i=0;i<count;i++){
          const s = document.createElement('div');
          s.className = 'skeleton-node';
          s.innerHTML = `
            <div class="timeline-marker" aria-hidden="true">
              <span class="node-dot"></span>
              <span class="node-line"></span>
            </div>
            <div class="timeline-body">
              <div class="node-header">
                <div class="skeleton-line short"></div>
                <div class="skeleton-line xsmall"></div>
              </div>
              <div class="skeleton-line medium"></div>
              <div class="skeleton-line medium"></div>
              <div class="skeleton-line small"></div>
            </div>
          `;
          wrapper.appendChild(s);
        }
        grid.appendChild(wrapper);
        grid.setAttribute('aria-busy','true');
      }

      function renderCards(cases){
        grid.innerHTML = '';
        (cases || []).forEach(function(c){
          const art = document.createElement('article');
          art.className = 'timeline-node case-card';
          art.setAttribute('data-year', c.year);
          art.tabIndex = 0;

          const marker = document.createElement('div'); marker.className = 'timeline-marker'; marker.setAttribute('aria-hidden','true');
          const dot = document.createElement('span'); dot.className = 'node-dot';
          const line = document.createElement('span'); line.className = 'node-line';
          marker.appendChild(dot); marker.appendChild(line);

          const body = document.createElement('div'); body.className = 'timeline-body';
          const header = document.createElement('div'); header.className = 'node-header';
          const h3 = document.createElement('h3'); h3.id = `case-${c.id}-title`; h3.textContent = c.title;
          const meta = document.createElement('div'); meta.className = 'node-meta'; meta.textContent = c.date;
          header.appendChild(h3); header.appendChild(meta);
          const p = document.createElement('p'); p.className = 'node-summary'; p.textContent = c.summary;
          const tagsWrap = document.createElement('div'); tagsWrap.className = 'node-tags';
          (c.tags || []).forEach(function(t){ const ts = document.createElement('span'); ts.className='tag'; ts.textContent = t; tagsWrap.appendChild(ts); });
          const actions = document.createElement('div'); actions.className = 'node-actions';
          const btn = document.createElement('button'); btn.className = 'open-case'; btn.setAttribute('data-target', c.slug); btn.setAttribute('aria-label', `Open Case ${c.id}`); btn.textContent = 'Open Case →';
          actions.appendChild(btn);

          body.appendChild(header);
          body.appendChild(p);
          body.appendChild(tagsWrap);
          body.appendChild(actions);

          art.appendChild(marker);
          art.appendChild(body);
          grid.appendChild(art);
        });
        grid.setAttribute('aria-busy','false');
        wireInteractions();
      }

      function wireInteractions(){
        // Idempotent wiring: avoid adding duplicate listeners
        // open-case buttons
        document.querySelectorAll('.open-case').forEach(function(el){
          if(el.dataset.wired === 'true') return; el.dataset.wired = 'true';
          el.addEventListener('click', function(e){
            e.preventDefault();
            const target = this.getAttribute('data-target');
            // show loader then navigate (support swup global if available)
            animateLoader(800).then(() => {
              // prefer swup if present
              try{
                if(window.__swup && typeof window.__swup.visit === 'function'){
                  document.documentElement.setAttribute('data-swup-transition','slide-left');
                  window.__swup.visit(target);
                  return;
                }
                if(window.Swup && typeof window.Swup === 'function'){
                  const temp = new window.Swup(); temp.visit(target); return;
                }
              }catch(e){ /* continue to fallback */ }
              if(target) window.location.href = target;
            });
          });
        });

        // keyboard + click anywhere on node
        document.querySelectorAll('.timeline-node').forEach(function(card){
          if(card.dataset.wired === 'true') return; card.dataset.wired = 'true';
          card.addEventListener('keydown', function(e){
            if(e.key === 'Enter' || e.key === ' '){
              const btn = this.querySelector('.open-case'); if(btn) btn.click(); e.preventDefault();
            }
          });
          card.addEventListener('click', function(e){
            const tag = (e.target && e.target.tagName || '').toLowerCase();
            if(tag === 'button' || tag === 'a' || tag === 'input') return;
            const btn = this.querySelector('.open-case'); if(btn) btn.click();
          });
        });
      }

      // filtering
      function initPills(){
        const pills = Array.from(document.querySelectorAll('.pill'));
        pills.forEach(function(p){ p.addEventListener('click', function(){ pills.forEach(function(x){ x.setAttribute('aria-pressed','false'); }); this.setAttribute('aria-pressed','true'); const year = this.getAttribute('data-year') || 'all'; document.querySelectorAll('.case-card').forEach(function(c){ var el = c; var dy = el.getAttribute('data-year') || ''; var show = year === 'all' || dy === year || (year === '1990s' && dy.indexOf('199') === 0) || (year === '2010s' && dy.indexOf('201') === 0); el.style.display = show ? '' : 'none'; }); }); });
      }

      // Public exposure for other scripts
      window.__dossier = window.__dossier || {};
      window.__dossier.animateLoader = animateLoader;

      // Initial flow when this script runs (page load or swup content replaced)
  async function initPage(){
        // ensure loading state
        dossierMain.classList.add('loading');
        accessPanel.style.display = '';
        accessPanel.style.opacity = '1';
        accessPanel.style.pointerEvents = 'auto';

  // run loader, reveal content, show skeletons, then render
  // Use ~6s so total load time is within 5-7 seconds
  await animateLoader(6000);
        showSkeletons(6);
        showDossierContent();
        await new Promise(r => setTimeout(r, 260));
        const data = window.__CASES || [];
        renderCards(data);
        initPills();
      }

      // Swup integration: if a global swup instance or event exists, re-run init on content replaced
      function bindSwupEvents(){
        try{
          const swupInstance = window.__swup || (window.swup && window.swup);
          if(swupInstance && swupInstance.on){
            // re-init when swup has replaced page content
            swupInstance.on('swup:contentReplaced', initPage);
          } else if(window.addEventListener){
            // older/global events
            document.addEventListener('swup:contentReplaced', initPage);
          }
        }catch(e){ /* ignore if swup not present */ }
      }

      // run for first load
      initPage();
      bindSwupEvents();

    })();
  </script>
</Layout>